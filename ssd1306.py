# MicroPython SSD1306 OLED driver, I2C mode
from machine import I2C, Pin
import time

# SSD1306 commands
SET_CONTRAST = 0x81
DISPLAY_ALL_ON_RESUME = 0xA4
DISPLAY_ALL_ON = 0xA5
NORMAL_DISPLAY = 0xA6
INVERSE_DISPLAY = 0xA7
DISPLAY_OFF = 0xAE
DISPLAY_ON = 0xAF
SET_DISPLAY_OFFSET = 0xD3
SET_COM_PIN_CFG = 0xDA
SET_MEMORY_ADDRESSING = 0x20
SET_SEGMENT_REMAP = 0xA0
SET_COM_OUTPUT_DIR = 0xC0
SET_COM_PIN_CFG_ALT = 0xD9
SET_VCOM_DESELECT = 0xDB
SET_CLOCK_DIV = 0xD5
SET_PRECHARGE = 0xD9
SET_MULTIPLEX = 0xA8
SET_LOW_COLUMN_ADDR = 0x00
SET_HIGH_COLUMN_ADDR = 0x10
SET_START_LINE = 0x40
SET_PAGE_ADDR = 0xB0
MEMORY_MODE = 0x20
COLUMN_ADDR = 0x21
PAGE_ADDR = 0x22
COM_SCAN_INC = 0xC0
COM_SCAN_DEC = 0xC8
ACTIVATE_SCROLL = 0x2F
DEACTIVATE_SCROLL = 0x2E
SET_VERTICAL_SCROLL_AREA = 0xA3
RIGHT_HORIZONTAL_SCROLL = 0x26
LEFT_HORIZONTAL_SCROLL = 0x27
DIAG_DOWN_RIGHT_SCROLL = 0x29
DIAG_UP_RIGHT_SCROLL = 0x2A
DIAG_DOWN_LEFT_SCROLL = 0x2A
DIAG_UP_LEFT_SCROLL = 0x2B

class SSD1306:
    def __init__(self, width, height, i2c, addr=0x3C, external_vcc=False):
        self.width = width
        self.height = height
        self.external_vcc = external_vcc
        self.pages = height // 8
        self.buffer = bytearray(self.pages * width)
        self.addr = addr
        self.i2c = i2c
        self.power_on()
        self.init_display()
        
    def init_display(self):
        for cmd in (
            SET_DISPLAY_OFF,  # 0xAE
            SET_CLOCK_DIV, 0x80,  # 0xD5
            SET_MULTIPLEX, self.height - 1,  # 0xA8
            SET_DISPLAY_OFFSET, 0x00,  # 0xD3
            SET_START_LINE | 0x00,  # 0x40
            SET_MEMORY_ADDRESSING, 0x00,  # 0x20  # horizontal addressing mode
            SET_SEGMENT_REMAP | 0x01,  # 0xA0  # column 127 mapped to SEG0
            SET_COM_PIN_CFG, 0x12,  # 0xDA
            SET_COM_PIN_CFG_ALT, 0x02,  # 0xD9
            SET_VCOM_DESELECT, 0x40,  # 0xDB  # VCOMH deselect level
            SET_CONTRAST, 0xCF,  # 0x81
            SET_PRECHARGE, 0xF1,  # 0xD9
            SET_DISPLAY_ALL_ON_RESUME,  # 0xA4
            SET_NORMAL_DISPLAY,  # 0xA6
            SET_ENTIRE_DISPLAY_ON,  # 0xA5
            SET_MEMORY_MODE, 0x00,  # 0x20  # horizontal addressing mode
            SET_COLUMN_ADDR, 0, self.width - 1,  # 0x21
            SET_PAGE_ADDR, 0, self.pages - 1,  # 0x22
            ACTIVATE_SCROLL,  # 0x2F
        ):
            self.write_cmd(cmd)
        self.fill(0)
        self.show()
        
    def power_on(self):
        self.write_cmd(DISPLAY_ON)
        
    def power_off(self):
        self.write_cmd(DISPLAY_OFF)
        
    def contrast(self, contrast):
        self.write_cmd(SET_CONTRAST)
        self.write_cmd(contrast)
        
    def invert(self, invert):
        self.write_cmd(INVERSE_DISPLAY if invert else NORMAL_DISPLAY)
        
    def show(self):
        self.write_cmd(SET_COLUMN_ADDR)
        self.write_cmd(0)
        self.write_cmd(self.width - 1)
        self.write_cmd(SET_PAGE_ADDR)
        self.write_cmd(0)
        self.write_cmd(self.pages - 1)
        
        # Write buffer
        self.i2c.writeto_mem(self.addr, 0x40, self.buffer)
        
    def fill(self, col):
        self.buffer = bytearray([col] * (self.pages * self.width))
        
    def pixel(self, x, y, col):
        if 0 <= x < self.width and 0 <= y < self.height:
            page = y // 8
            idx = page * self.width + x
            bit = y & 7
            if col:
                self.buffer[idx] |= 1 << bit
            else:
                self.buffer[idx] &= ~(1 << bit)
                
    def text(self, string, x, y, col=1):
        import framebuf
        for i, c in enumerate(string):
            self.text_char(c, x + i * 8, y, col)
            
    def text_char(self, char, x, y, col=1):
        import framebuf
        # 8x8 font
        font = [
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  # space
            0x00, 0x00, 0x5F, 0x00, 0x00, 0x00, 0x00, 0x00,  # !
            0x00, 0x07, 0x00, 0x07, 0x00, 0x07, 0x00, 0x00,  # "
            0x14, 0x7F, 0x14, 0x7F, 0x14, 0x7F, 0x14, 0x00,  # #
            0x24, 0x2A, 0x7F, 0x2A, 0x7F, 0x12, 0x23, 0x00,  # $             0x23, 0x13, 0x08, 0x64, 0x62, 0x28, 0x23, 0x00,  # %
            0x36, 0x49, 0x55, 0x22, 0x50, 0x79, 0x49, 0x00,  # &
            0x00, 0x00, 0x05, 0x03, 0x00, 0x00, 0x00, 0x00,  # '
            0x00, 0x1C, 0x22, 0x41, 0x00, 0x00, 0x00, 0x00,  # (
            0x00, 0x41, 0x22, 0x1C, 0x00, 0x00, 0x00, 0x00,  # )
            0x2A, 0x1C, 0x7F, 0x1C, 0x2A, 0x00, 0x00, 0x00,  # *
            0x08, 0x08, 0x3E, 0x08, 0x08, 0x00, 0x00, 0x00,  # +
            0x00, 0x50, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00,  # ,
            0x08, 0x08, 0x08, 0x08, 0x08, 0x00, 0x00, 0x00,  # -
            0x00, 0x60, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00,  # .
            0x20, 0x10, 0x08, 0x04, 0x02, 0x00, 0x00, 0x00,  # /
            0x3E, 0x51, 0x49, 0x45, 0x3E, 0x00, 0x00, 0x00,  # 0
            0x00, 0x42, 0x7F, 0x40, 0x00, 0x00, 0x00, 0x00,  # 1
            0x42, 0x61, 0x51, 0x49, 0x46, 0x00, 0x00, 0x00,  # 2
            0x21, 0x41, 0x45, 0x4B, 0x31, 0x00, 0x00, 0x00,  # 3
            0x18, 0x14, 0x12, 0x7F, 0x10, 0x00, 0x00, 0x00,  # 4
            0x27, 0x45, 0x45, 0x45, 0x39, 0x00, 0x00, 0x00,  # 5
            0x3C, 0x4A, 0x49, 0x49, 0x30, 0x00, 0x00, 0x00,  # 6
            0x01, 0x71, 0x09, 0x05, 0x03, 0x00, 0x00, 0x00,  # 7
            0x36, 0x49, 0x49, 0x49, 0x36, 0x00, 0x00, 0x00,  # 8
            0x06, 0x49, 0x49, 0x29, 0x1E, 0x00, 0x00, 0x00,  # 9
            0x00, 0x36, 0x36, 0x00, 0x00, 0x00, 0x00, 0x00,  # :
            0x00, 0x56, 0x36, 0x00, 0x00, 0x00, 0x00, 0x00,  # ;
            0x08, 0x14, 0x22, 0x41, 0x00, 0x00, 0x00, 0x00,  # <
            0x14, 0x14, 0x14, 0x14, 0x14, 0x00, 0x00, 0x00,  # =
            0x41, 0x22, 0x14, 0x08, 0x00, 0x00, 0x00, 0x00,  # >
            0x02, 0x01, 0x51, 0x09, 0x06, 0x00, 0x00, 0x00,  # ?
            0x32, 0x49, 0x79, 0x41, 0x3E, 0x00, 0x00, 0x00,  # @
            0x7E, 0x11, 0x11, 0x11, 0x7E, 0x00, 0x00, 0x00,  # A
            0x7F, 0x49, 0x49, 0x49, 0x36, 0x00, 0x00, 0x00,  # B
            0x3E, 0x41, 0x41, 0x41, 0x22, 0x00, 0x00, 0x00,  # C
            0x7F, 0x41, 0x41, 0x41, 0x3E, 0x00, 0x00, 0x00,  # D
            0x7F, 0x49, 0x49, 0x49, 0x41, 0x00, 0x00, 0x00,  # E
            0x7F, 0x09, 0x09, 0x09, 0x01, 0x00, 0x00, 0x00,  # F
            0x3E, 0x41, 0x49, 0x49, 0x7A, 0x00, 0x00, 0x00,  # G
            0x7F, 0x08, 0x08, 0x08, 0x7F, 0x00, 0x00, 0x00,  # H
            0x00, 0x41, 0x7F, 0x41, 0x00, 0x00, 0x00, 0x00,  # I
            0x20, 0x40, 0x41, 0x3F, 0x01, 0x00, 0x00, 0x00,  # J
            0x7F, 0x08, 0x14, 0x22, 0x41, 0x00, 0x00, 0x00,  # K
            0x7F, 0x40, 0x40, 0x40, 0x40, 0x00, 0x00, 0x00,  # L
            0x7F, 0x02, 0x0C, 0x02, 0x7F, 0x00, 0x00, 0x00,  # M
            0x7F, 0x04, 0x08, 0x10, 0x7F, 0x00, 0x00, 0x00,  # N
            0x3E, 0x41, 0x41, 0x41, 0x3E, 0x00, 0x00, 0x00,  # O
            0x7F, 0x09, 0x09, 0x09, 0x06, 0x00, 0x00, 0x00,  # P
            0x1E, 0x21, 0x41, 0x45, 0x4A, 0x00, 0x00, 0x00,  # Q
            0x7F, 0x09, 0x09, 0x09, 0x0F, 0x00, 0x00, 0x00,  # R
            0x2A, 0x7F, 0x49, 0x49, 0x36, 0x00, 0x00, 0x00,  # S
            0x03, 0x04, 0x78, 0x04, 0x03, 0x00, 0x00, 0x00,  # T
            0x41, 0x41, 0x41, 0x41, 0x3E, 0x00, 0x00, 0x00,  # U
            0x41, 0x41, 0x41, 0x22, 0x1C, 0x00, 0x00, 0x00,  # V
            0x41, 0x41, 0x49, 0x49, 0x7A, 0x00, 0x00, 0x00,  # W
            0x7F, 0x08, 0x04, 0x08, 0x7F, 0x00, 0x00, 0x00,  # X
            0x03, 0x04, 0x78, 0x04, 0x03, 0x00, 0x00, 0x00,  # Y
            0x61, 0x51, 0x49, 0x45, 0x46, 0x00, 0x00, 0x00,  # Z
            0x00, 0x00, 0x7F, 0x41, 0x41, 0x00, 0x00, 0x00,  # [
            0x02, 0x04, 0x08, 0x10, 0x20, 0x00, 0x00, 0x00,  # \
            0x00, 0x41, 0x41, 0x7F, 0x00, 0x00, 0x00, 0x00,  # ]
            0x04, 0x02, 0x01, 0x02, 0x04, 0x00, 0x00, 0x00,  # ^
            0x40, 0x40, 0x40, 0x40, 0x40, 0x00, 0x00, 0x00,  # _
            0x00, 0x01, 0x02, 0x04, 0x00, 0x00, 0x00, 0x00,  # `
            0x20, 0x54, 0x54, 0x54, 0x78, 0x00, 0x00, 0x00,  # a
            0x7F, 0x48, 0x44, 0x44, 0x38, 0x00, 0x00, 0x00,  # b
            0x38, 0x44, 0x44, 0x44, 0x28, 0x00, 0x00, 0x00,  # c
            0x38, 0x44, 0x44, 0x48, 0x7F, 0x00, 0x00, 0x00,  # d
            0x38, 0x54, 0x54, 0x54, 0x18, 0x00, 0x00, 0x00,  # e
            0x08, 0x7E, 0x09, 0x01, 0x02, 0x00, 0x00, 0x00,  # f
            0x0C, 0x52, 0x52, 0x52, 0x3E, 0x00, 0x00, 0x00,  # g
            0x7F, 0x08, 0x04, 0x04, 0x78, 0x00, 0x00, 0x00,  # h
            0x00, 0x44, 0x7D, 0x40, 0x00, 0x00, 0x00, 0x00,  # i
            0x20, 0x40, 0x44, 0x3D, 0x00, 0x00, 0x00, 0x00,  # j
            0x7F, 0x10, 0x28, 0x44, 0x00, 0x00, 0x00, 0x00,  # k
            0x00, 0x41, 0x7F, 0x40, 0x00, 0x00, 0x00, 0x00,  # l
            0x7C, 0x04, 0x18, 0x04, 0x78, 0x00, 0x00, 0x00,  # m
            0x7C, 0x08, 0x04, 0x04, 0x78, 0x00, 0x00, 0x00,  # n
            0x38, 0x44, 0x44, 0x44, 0x38, 0x00, 0x00, 0x00,  # o
            0x7C, 0x14, 0x14, 0x14, 0x08, 0x00, 0x00, 0x00,  # p
            0x08, 0x14, 0x14, 0x18, 0x7C, 0x00, 0x00, 0x00,  # q
            0x7F, 0x08, 0x04, 0x04, 0x08, 0x00, 0x00, 0x00,  # r
            0x0C, 0x2A, 0x2A, 0x2A, 0x34, 0x00, 0x00, 0x00,  # s
            0x04, 0x04, 0x3E, 0x44, 0x44, 0x00, 0x00, 0x00,  # t
            0x3C, 0x40, 0x40, 0x20, 0x7C, 0x00, 0x00, 0x00,  # u
            0x1C, 0x20, 0x40, 0x20, 0x1C, 0x00, 0x00, 0x00,  # v
            0x3C, 0x40, 0x30, 0x40, 0x3C, 0x00, 0x00, 0x00,  # w
            0x44, 0x28, 0x10, 0x28, 0x44, 0x00, 0x00, 0x00,  # x
            0x0C, 0x50, 0x50, 0x50, 0x3C, 0x00, 0x00, 0x00,  # y
            0x44, 0x64, 0x54, 0x4C, 0x44, 0x00, 0x00, 0x00,  # z
            0x00, 0x08, 0x36, 0x41, 0x00, 0x00, 0x00, 0x00,  # {
            0x00, 0x00, 0x7F, 0x00, 0x00, 0x00, 0x00, 0x00,  # |
            0x00, 0x41, 0x36, 0x08, 0x00, 0x00, 0x00, 0x00,  # }
            0x02, 0x01, 0x02, 0x04, 0x02, 0x00, 0x00, 0x00,  # ~
            0x04, 0x02, 0x01, 0x02, 0x04, 0x00, 0x00, 0x00,  # (c)
        ]
        
        char_code = ord(char)
        if char_code >= 32 and char_code <= 127:
            char_data = font[char_code - 32]
            for i in range(8):
                if char_data & (1 << i):
                    self.pixel(x + i, y, col)
                    
    def write_cmd(self, cmd):
        self.i2c.writeto_mem(self.addr, 0x00, bytes([cmd]))
        
    def write_data(self, buf):
        self.i2c.writeto_mem(self.addr, 0x40, buf)
